#!/bin/sh
set -e

ENV="/boot/armbianEnv.txt"

case "$1" in
    remove|purge)
        # 1) delete installed overlay files
        for dir in /boot/overlay-user /boot/dtb/rockchip/overlay-user /boot/dtb/rockchip/overlay; do
            [ -f "$dir/rk3588-pwm14-fan.dtbo" ] && rm -f "$dir/rk3588-pwm14-fan.dtbo"
            [ -f "$dir/rk3588-pwm14-m1.dtbo" ] && rm -f "$dir/rk3588-pwm14-m1.dtbo"
        done

        # 2) strip overlays from user_overlays line
        if [ -f "$ENV" ] && grep -q "^user_overlays=" "$ENV"; then
            sed -i 's/\s*pwm-fan\s*//g; s/\s*pwm14-fan\s*//g; s/\s*pwm14-m1\s*//g; s/  */ /g' "$ENV"
            sed -i '/^user_overlays=\s*$/d' "$ENV"
        fi
        ;;
esac

exit 0
